<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Recognition</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Live Transcription</h1>
    
    <label for="language_id">Select Language:</label>
    <select id="language_id">
        <option value="Apatani">Apatani</option>
        <option value="Bhutanese">Bhutanese</option>
        <option value="French">French</option>
        <option value="Hindi">Hindi</option>
        <option value="Monpa">Monpa</option>
    </select>
    <button id="start-button">Start Transcription</button>

    <p id="transcription">No transcription yet...</p>
    <audio id="audioPlayer" controls></audio>

    <script>
        const socket = io.connect();
        const startButton = document.getElementById('start-button');
        const languageSelect = document.getElementById('language_id');
        const transcriptionDiv = document.getElementById('transcription');

        let lastPlayedSentence = null;

        // Function to send selected language to Flask
        function selectLanguage(languageId) {
            fetch('/select_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `language_id=${languageId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Language updated successfully');
                } else {
                    console.log('Error updating language');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Convert Float32 PCM to Int16 PCM
        function convertFloat32ToInt16(buffer) {
            const l = buffer.length;
            const buf = new Int16Array(l);
            for (let i = 0; i < l; i++) {
                buf[i] = Math.max(-1, Math.min(1, buffer[i])) * 0x7FFF; // Ensure values are in Int16 range
            }
            return buf.buffer;
        }

        // Start button listener
        startButton.addEventListener('click', function() {
            const languageId = languageSelect.value;
            selectLanguage(languageId);

            // Request access to the user's microphone
            navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000, channelCount: 1 } })
                .then(stream => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                    const mediaStreamSource = audioContext.createMediaStreamSource(stream);
                    const scriptProcessor = audioContext.createScriptProcessor(8192, 1, 1); // Use a smaller buffer size

                    mediaStreamSource.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);

                    // Capture and process audio in real-time
                    scriptProcessor.onaudioprocess = function(event) {
                        const inputData = event.inputBuffer.getChannelData(0); // Float32 PCM
                        const int16Data = convertFloat32ToInt16(inputData); // Convert to Int16

                        // Send raw PCM data to Flask via WebSocket
                        socket.emit('audio_stream', int16Data);
                    };
                })
                .catch(err => console.log('Error accessing microphone: ', err));
        });

        // Handle transcription data from Flask
        socket.on('transcription', function(data) {
            transcriptionDiv.innerText = data.transcription;

            // Additional handling for matched sentences can be added here
        });
    </script>
</body>
</html>

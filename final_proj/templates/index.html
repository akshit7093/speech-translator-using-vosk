<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Speech Recognition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #transcription {
            margin-top: 20px;
            font-size: 18px;
            white-space: pre-wrap; /* Preserve line breaks */
        }
    </style>
    <!-- Include the Socket.IO client library -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Real-time Speech-to-Text with Socket.IO</h1>
    <button id="start-button">Start Transcription</button>
    <div id="transcription">Transcription will appear here...</div>

    <script>
        const startButton = document.getElementById('start-button');
        const transcriptionDiv = document.getElementById('transcription');
        let audioContext, mediaStream, socket, processor;

        function convertFloat32ToInt16(buffer) {
            const l = buffer.length;
            const buf = new Int16Array(l);
            for (let i = 0; i < l; i++) {
                buf[i] = Math.max(-1, Math.min(1, buffer[i])) * 0x7FFF; // Ensure values are in Int16 range
            }
            return buf.buffer;
        }

        startButton.addEventListener('click', function() {
            // Initialize Socket.IO
            socket = io(); // Connect to the same origin

            socket.on('connect', () => {
                console.log('Socket.IO connection established');
            });

            socket.on('transcription', (data) => {
                transcriptionDiv.innerText = 'Transcription: ' + data.transcription;
            });

            socket.on('disconnect', () => {
                console.log('Socket.IO connection closed');
            });

            socket.on('error', (error) => {
                console.error('Socket.IO Error: ', error);
                cleanup(); // Stop and close the audio stream on error
            });

            // Capture audio from the microphone
            navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000, channelCount: 1 } })
                .then((stream) => {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                    mediaStream = audioContext.createMediaStreamSource(stream);
                    processor = audioContext.createScriptProcessor(8192, 1, 1); // Use a smaller buffer size

                    // Set up audio processing
                    processor.onaudioprocess = (e) => {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const int16Data = convertFloat32ToInt16(inputData);
                        sendAudioData(int16Data);
                    };

                    mediaStream.connect(processor);
                    processor.connect(audioContext.destination);
                })
                .catch((err) => {
                    console.error('Error accessing microphone: ', err);
                    cleanup(); // Stop and close the audio stream on error
                });

            function sendAudioData(int16Data) {
                if (socket.connected) {
                    socket.emit('audio', int16Data); // Send audio data via Socket.IO
                } else {
                    console.log('Socket.IO is not connected. Current state: ' + socket.connected);
                }
            }
        });

        // Function to cleanup and stop audio processing
        function cleanup() {
            if (processor) {
                processor.disconnect();
                processor.onaudioprocess = null;
            }
            if (mediaStream) {
                mediaStream.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
            console.log('Audio stream stopped and cleaned up');
        }
    </script>
</body>
</html>
